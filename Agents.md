# Agents.md

> 이 문서는 코드 생성/리팩터링 에이전트(Codex 등)가 레포지토리를 이해하고, 안전하게 Java 모놀리스를 **Rust 기반 마이크로서비스**로 마이그레이션하기 위한 실행 지침입니다.

---

## 0. 목표

* `marubase/`에 있는 **Java 스프링 모놀리식**(레거시)을 **수정하지 않고** 참조 대상으로 유지합니다.
* `marust/`에서 **Rust 마이크로서비스**로 단계적 분리/이관을 진행합니다.
* 네이밍은 가능하면 `marubase`의 기존 명칭/용어를 그대로 사용합니다. (예: `user`를 `member`로 임의 변경하지 않음)
* 이슈/PR은 레포 내 템플릿을 **반드시** 준수합니다.
* 언제나 한글로 답변합니다.

---

## 1. 레포 구조와 권한

```text
/ (repo root)
├─ marubase/   # Java(Spring) 모놀리식: 참조 전용, 절대 수정 금지
├─ marust/     # Rust 마이크로서비스 작업 공간 (신규/변경 파일은 모두 여기)
└─ .github/
   ├─ ISSUE_TEMPLATE/               # 이슈 템플릿 폴더(참고하여 신규 템플릿 작성)
   └─ PULL_REQUEST_TEMPLATE.md      # PR 템플릿(참고하여 신규 템플릿 작성)
```

### 수정 금지 규칙

* `marubase/` 디렉터리 **내 파일 생성/수정/삭제 금지**
* `marubase/` 경로/모듈명 **변경 금지**

### 작업 위치 규칙

* 모든 신규 코드, 설정, 스크립트는 **`marust/`**\*\* 하위\*\*에만 추가합니다.
* 공용 스크립트/CI 구성 등이 필요할 경우, 루트에 두되 `marubase/`에는 접촉하지 않습니다.

---

## 2. 마이그레이션 원칙 (Do / Don't)

**Do**

* Java 모놀리식의 기능/경계(패키지, 모듈, API)를 분석해 **서비스 경계**를 정의하고, 해당 경계 단위로 Rust 서비스 생성
* 기능 이전 시, 우선 **외부 계약(API/이벤트/스키마) 유지** → 내부 구현만 교체
* 서비스 간 통신은 우선 **HTTP/REST**(간단) → 필요 시 gRPC 채택
* 점진적 전환(스트랭글러 패턴): 트래픽 일부를 신규 서비스로 라우팅, 회귀 시 빠른 롤백 가능
* 네이밍과 도메인 용어는 `marubase` 기준을 따름
* 따로 언급이 없을 경우, 내부 로직은 `marubase`를 따라서 진행한다.

**Don't**

* 레거시 코드에 직접 수정을 가하지 않음 (`marubase/*` 일체 금지)
* 한 PR에 다수 서비스/도메인을 섞지 않음
* 데이터 스키마를 임의로 변경하지 않음

---

## 3. Rust 서비스 표준

* **Rust edition**: 2021 이상 (가능하면 최신 stable)
* **패키징**: 각 서비스는 독립 Cargo crate (workspace 사용 권장)
* **런타임**: tokio
* **웹 프레임워크**: axum (기본)
* **직렬화**: serde/serde\_json
* **구성 관리**: `config` crate + 환경변수 (12-factor)
* **로그/추적**: tracing, OpenTelemetry(옵션)
* **에러 처리**: anyhow/thiserror 조합
* **DB**: sqlx(비동기) 또는 sea-orm
* **보안 기본값**: 입력 검증, 타임아웃/리트라이, 최소 권한의 비밀키 주입(.env는 개발용만)

---

## 4. 데이터 마이그레이션

> 이번 마이그레이션에서는 DB 구조 변경을 예상하지 않으므로, 데이터 마이그레이션 작업은 일반적으로 필요하지 않습니다. 다만 불가피하게 변경이 생기는 경우에만 다음을 적용합니다.

* DB 변경은 **DDL 스크립트 + 마이그레이션 도구**로 관리
* 다운타임 최소화 전략 사용

---

## 5. 배포/운영

* **컨테이너**: 각 서비스 Dockerfile 보유, 멀티스테이지 빌드
* **헬스체크**: `/health`(liveness), `/ready`(readiness)
* **관측성**: 요청 ID, 분산 추적(trace id) 전파

---

## 6. 작업 단위와 브랜치/PR 규칙

* 브랜치 네이밍과 커밋 메시지 규칙은 \*\*`CONTRIBUTING.md`\*\*를 참고
* 한 PR = 한 목적(서비스/기능 단위)
* **리뷰 필수** + CI 통과 필수

### 이슈 & PR 템플릿 준수

* 이슈: `.github/ISSUE_TEMPLATE/` 참고하여 작성
* PR: `.github/PULL_REQUEST_TEMPLATE.md` 참고하여 작성

---

## 7. 비목표(Non-Goals)

* `marubase/` 리팩터링/최적화/의존성 업그레이드 — **이번 범위 아님**
* 대규모 아키텍처 변경 — 별도 RFC 필요

---

## 8. 작업 예시(에이전트에게)

1. `marubase/`의 `com.example.account` 관련 REST 엔드포인트 목록과 DTO를 추출
2. 동등 API를 제공하는 `marust/services/account` 생성
3. OpenAPI 스펙 작성 후 구현
4. 라우팅 계층에서 트래픽 샘플을 신규 서비스로 전환
5. 안정 시 트래픽 100% 전환

---

## 9. 문의/결정 트랙

* 서비스 경계 변경이나 공통 라이브러리 도입 등 **아키텍처 영향** 있는 변경은 이슈로 RFC 작성 후 진행
* 긴급 예외가 필요한 경우에도 `marubase/` 직접 수정은 금지


